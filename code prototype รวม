import React, { useMemo, useState } from "react";
import { Camera, Image as ImageIcon, HeartPulse, Brain, Search, Info, AlertTriangle, CheckCircle2, Leaf, Activity, Loader2 } from "lucide-react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Progress } from "@/components/ui/progress";

// =============================
// üî∞ Prototype-only data (mock)
// =============================
const HERBS = [
  {
    id: "turmeric",
    nameTH: "‡∏Ç‡∏°‡∏¥‡πâ‡∏ô‡∏ä‡∏±‡∏ô",
    nameEN: "Turmeric",
    uses: ["‡∏™‡∏¥‡∏ß‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö", "‡∏ú‡∏∑‡πà‡∏ô‡∏Ñ‡∏±‡∏ô", "‡πÅ‡∏ú‡∏•‡∏ñ‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"],
    cautions: ["‡∏≠‡∏≤‡∏à‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏∑‡∏≠‡∏á‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏Å‡πà‡∏≠‡∏ô", "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏≤‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÅ‡∏ú‡∏•‡∏•‡∏∂‡∏Å/‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠"],
    evidenceNote: "‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πâ‡∏≤‡∏ô‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°",
  },
  {
    id: "aloe",
    nameTH: "‡∏ß‡πà‡∏≤‡∏ô‡∏´‡∏≤‡∏á‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ",
    nameEN: "Aloe vera",
    uses: ["‡∏ú‡∏¥‡∏ß‡πÑ‡∏´‡∏°‡πâ‡πÅ‡∏î‡∏î", "‡πÅ‡∏ú‡∏•‡∏ñ‡∏•‡∏≠‡∏Å", "‡∏ú‡∏¥‡∏ß‡πÅ‡∏´‡πâ‡∏á‡∏•‡∏≠‡∏Å"],
    cautions: ["‡∏≠‡∏≤‡∏à‡πÅ‡∏û‡πâ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢", "‡πÉ‡∏ä‡πâ‡πÄ‡∏à‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ"],
    evidenceNote: "‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ô‡πÅ‡∏û‡∏£‡πà‡∏´‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏ú‡∏¥‡∏ß‡πÑ‡∏´‡∏°‡πâ‡πÅ‡∏î‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πâ‡∏ô",
  },
  {
    id: "gotukola",
    nameTH: "‡πÉ‡∏ö‡∏ö‡∏±‡∏ß‡∏ö‡∏Å",
    nameEN: "Centella asiatica (Gotu kola)",
    uses: ["‡∏•‡∏î‡∏£‡∏≠‡∏¢‡πÅ‡∏î‡∏á", "‡πÅ‡∏ú‡∏•‡∏ï‡∏∑‡πâ‡∏ô"],
    cautions: ["‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô/‡∏™‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"],
    evidenceNote: "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ß‡∏ä‡∏™‡∏≥‡∏≠‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏ú‡∏¥‡∏ß",
  },
  {
    id: "plai",
    nameTH: "‡πÑ‡∏û‡∏•",
    nameEN: "Zingiber cassumunar (Plai)",
    uses: ["‡∏ú‡∏∑‡πà‡∏ô‡∏Ñ‡∏±‡∏ô", "‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"],
    cautions: ["‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏≠‡∏°‡∏£‡∏∞‡πÄ‡∏´‡∏¢‡∏≠‡∏≤‡∏à‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡∏ú‡∏¥‡∏ß ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏à‡∏∑‡∏≠‡∏à‡∏≤‡∏á"],
    evidenceNote: "‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πâ‡∏≤‡∏ô‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÉ‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô",
  },
  {
    id: "teatree",
    nameTH: "‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏£‡∏µ",
    nameEN: "Tea tree oil",
    uses: ["‡∏™‡∏¥‡∏ß", "‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏ï‡∏±‡∏ß"],
    cautions: ["‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏∑‡∏≠‡∏à‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ", "‡∏≠‡∏≤‡∏à‡∏£‡∏∞‡∏Ñ‡∏≤‡∏¢‡∏ú‡∏¥‡∏ß‡πÑ‡∏î‡πâ"],
    evidenceNote: "‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πâ‡∏≤‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ö‡∏ô‡∏ú‡∏¥‡∏ß ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á",
  },
];

const CONDITIONS = {
  acne: {
    id: "acne",
    nameTH: "‡∏™‡∏¥‡∏ß",
    symptoms: ["‡∏ï‡∏∏‡πà‡∏°‡∏´‡∏ô‡∏≠‡∏á", "‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö", "‡∏°‡∏±‡∏ô"],
    herbs: ["turmeric", "teatree", "gotukola"],
    care: [
      "‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô",
      "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡∏∞‡∏™‡∏¥‡∏ß",
      "‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏Å‡πà‡∏≠‡∏ô",
    ],
  },
  dermatitis: {
    id: "dermatitis",
    nameTH: "‡∏ú‡∏∑‡πà‡∏ô‡πÅ‡∏û‡πâ‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™/‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö",
    symptoms: ["‡∏Ñ‡∏±‡∏ô", "‡πÅ‡∏î‡∏á", "‡πÅ‡∏´‡πâ‡∏á‡∏•‡∏≠‡∏Å"],
    herbs: ["aloe", "gotukola", "plai"],
    care: ["‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô", "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏û‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ"],
  },
  tinea: {
    id: "tinea",
    nameTH: "‡∏Å‡∏•‡∏≤‡∏Å/‡πÄ‡∏Å‡∏•‡∏∑‡πâ‡∏≠‡∏ô (‡∏™‡∏á‡∏™‡∏±‡∏¢)",
    symptoms: ["‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á", "‡∏Ñ‡∏±‡∏ô", "‡∏Ç‡∏≠‡∏ö‡∏ä‡∏±‡∏î"],
    herbs: ["teatree", "turmeric"],
    care: ["‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô", "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏´‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏¥‡∏ß"],
  },
  sunburn: {
    id: "sunburn",
    nameTH: "‡∏ú‡∏¥‡∏ß‡πÑ‡∏´‡∏°‡πâ‡πÅ‡∏î‡∏î",
    symptoms: ["‡πÅ‡∏™‡∏ö‡∏£‡πâ‡∏≠‡∏ô", "‡πÅ‡∏î‡∏á"],
    herbs: ["aloe", "gotukola"],
    care: ["‡∏õ‡∏£‡∏∞‡∏Ñ‡∏ö‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡πÜ", "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏î‡∏î‡∏ã‡πâ‡∏≥"],
  },
  minor_wound: {
    id: "minor_wound",
    nameTH: "‡πÅ‡∏ú‡∏•‡∏ñ‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
    symptoms: ["‡∏ñ‡∏•‡∏≠‡∏Å", "‡∏ï‡∏∑‡πâ‡∏ô"],
    herbs: ["aloe", "turmeric"],
    care: ["‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î", "‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ñ‡πâ‡∏≤‡πÅ‡∏ú‡∏•‡∏•‡∏∂‡∏Å/‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠"],
  },
};

const KEYWORD_MAP = [
  { kws: ["‡∏™‡∏¥‡∏ß", "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡∏≠‡∏á", "‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô"], cond: "acne" },
  { kws: ["‡∏Ñ‡∏±‡∏ô", "‡∏ú‡∏∑‡πà‡∏ô", "‡πÅ‡∏û‡πâ", "‡∏•‡∏≠‡∏Å", "‡πÅ‡∏î‡∏á"], cond: "dermatitis" },
  { kws: ["‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á", "‡πÄ‡∏Å‡∏•‡∏∑‡πâ‡∏≠‡∏ô", "‡∏Å‡∏•‡∏≤‡∏Å"], cond: "tinea" },
  { kws: ["‡πÑ‡∏´‡∏°‡πâ", "‡πÅ‡∏î‡∏î", "‡πÅ‡∏™‡∏ö‡∏£‡πâ‡∏≠‡∏ô"], cond: "sunburn" },
  { kws: ["‡∏ñ‡∏•‡∏≠‡∏Å", "‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏•", "‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô"], cond: "minor_wound" },
];

function formatConfidence(num) {
  return (num * 100).toFixed(0) + "%";
}

function HerbBadge({ id }) {
  const herb = HERBS.find((h) => h.id === id);
  if (!herb) return null;
  return (
    <Badge className="mr-2 mb-2 flex items-center gap-1"><Leaf size={14} />{herb.nameTH}</Badge>
  );
}

function ResultBlock({ title, subtitle, herbs = [], tips = [], confidence = 0.78 }) {
  return (
    <Card className="border-2">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-xl">
          <CheckCircle2 className="text-green-600" /> {title}
        </CardTitle>
        {subtitle && <p className="text-sm text-muted-foreground mt-1">{subtitle}</p>}
      </CardHeader>
      <CardContent>
        {herbs.length > 0 && (
          <div className="mb-3">
            <div className="text-sm font-medium mb-2">‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏™‡∏≤‡∏ò‡∏¥‡∏ï)</div>
            <div className="flex flex-wrap">{herbs.map((id) => <HerbBadge key={id} id={id} />)}</div>
          </div>
        )}
        {tips.length > 0 && (
          <ul className="list-disc pl-6 space-y-1 text-sm text-muted-foreground">
            {tips.map((t, i) => (<li key={i}>{t}</li>))}
          </ul>
        )}
        <div className="mt-4">
          <div className="text-sm">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (‡∏à‡∏≥‡∏•‡∏≠‡∏á): {formatConfidence(confidence)}</div>
          <Progress value={confidence * 100} className="h-2 mt-1" />
        </div>
      </CardContent>
    </Card>
  );
}

// =============================
// Main Prototype Component
// =============================
export default function App() {
  const [tab, setTab] = useState("herb");

  // Herb photo
  const [herbFile, setHerbFile] = useState(null);
  const [herbPreview, setHerbPreview] = useState("");
  const [herbLoading, setHerbLoading] = useState(false);
  const [herbResult, setHerbResult] = useState(null);

  // Lesion photo
  const [lesionFile, setLesionFile] = useState(null);
  const [lesionPreview, setLesionPreview] = useState("");
  const [lesionLoading, setLesionLoading] = useState(false);
  const [lesionResult, setLesionResult] = useState(null);

  // Symptom text
  const [symptomText, setSymptomText] = useState("");
  const [symptomLoading, setSymptomLoading] = useState(false);
  const [symptomResult, setSymptomResult] = useState(null);

  const [openHerbDialog, setOpenHerbDialog] = useState(false);
  const [activeHerb, setActiveHerb] = useState(null);

  const previewURL = (file) => (file ? URL.createObjectURL(file) : "");

  const onUpload = (e, kind) => {
    const f = e.target.files?.[0];
    if (!f) return;
    if (kind === "herb") {
      setHerbFile(f);
      setHerbPreview(previewURL(f));
    } else {
      setLesionFile(f);
      setLesionPreview(previewURL(f));
    }
  };

  // ===== Simulated AI pipelines =====
  const simulateDelay = (ms) => new Promise((res) => setTimeout(res, ms));

  const runHerbIdentify = async () => {
    if (!herbFile) return;
    setHerbLoading(true);
    setHerbResult(null);
    await simulateDelay(1200);

    // Simple mock: map by filename hints or random
    const pick = ["turmeric", "aloe", "gotukola", "plai"][Math.floor(Math.random() * 4)];
    const conf = 0.75 + Math.random() * 0.2;
    const herb = HERBS.find((h) => h.id === pick);
    setHerbResult({
      herbId: pick,
      herbName: herb?.nameTH,
      suggestedFor: herb?.uses?.slice(0, 2) || [],
      confidence: conf,
    });
    setHerbLoading(false);
  };

  const runLesionDetect = async () => {
    if (!lesionFile) return;
    setLesionLoading(true);
    setLesionResult(null);
    await simulateDelay(1400);

    const keys = Object.keys(CONDITIONS);
    const pickKey = keys[Math.floor(Math.random() * keys.length)];
    const cond = CONDITIONS[pickKey];
    const conf = 0.68 + Math.random() * 0.25;
    setLesionResult({ cond, confidence: conf });
    setLesionLoading(false);
  };

  const runSymptomNLP = async () => {
    if (!symptomText.trim()) return;
    setSymptomLoading(true);
    setSymptomResult(null);
    await simulateDelay(900);

    const text = symptomText.trim();
    let matched = "dermatitis";
    for (const rule of KEYWORD_MAP) {
      if (rule.kws.some((kw) => text.includes(kw))) { matched = rule.cond; break; }
    }
    const cond = CONDITIONS[matched];
    const conf = 0.6 + Math.random() * 0.3;
    setSymptomResult({ cond, confidence: conf });
    setSymptomLoading(false);
  };

  const HerbDialog = () => {
    const herb = HERBS.find((h) => h.id === activeHerb);
    if (!herb) return null;
    return (
      <Dialog open={openHerbDialog} onOpenChange={setOpenHerbDialog}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2"><Leaf /> {herb.nameTH} <span className="text-sm text-muted-foreground">({herb.nameEN})</span></DialogTitle>
          </DialogHeader>
          <div className="space-y-3">
            <div>
              <div className="text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ï‡∏≥‡∏£‡∏≤/‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ:</div>
              <ul className="list-disc pl-6 text-sm mt-1">
                {herb.uses.map((u, i) => <li key={i}>{u}</li>)}
              </ul>
            </div>
            <div>
              <div className="text-sm font-medium">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á:</div>
              <ul className="list-disc pl-6 text-sm mt-1">
                {herb.cautions.map((c, i) => <li key={i}>{c}</li>)}
              </ul>
            </div>
            <p className="text-xs text-muted-foreground">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô: {herb.evidenceNote}</p>
          </div>
          <DialogFooter>
            <Button onClick={() => setOpenHerbDialog(false)}>‡∏õ‡∏¥‡∏î</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    );
  };

  const SchemaTab = () => {
    const schema = {
      Herb: {
        id: "string",
        localNames: ["string"],
        partsUsed: ["‡πÉ‡∏ö", "‡πÄ‡∏´‡∏á‡πâ‡∏≤", "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏à‡∏•"],
        topicalUses: ["string"],
        cautions: ["string"],
        evidence: { level: "A/B/C? (prototype)", notes: "string" },
      },
      Condition: {
        id: "string",
        nameTH: "string",
        symptoms: ["string"],
        herbRefs: ["Herb.id"],
      },
      InferenceOutput: {
        task: "herb-identify | lesion-detect | nlp-symptom",
        topK: [{ label: "id", score: 0.0 }],
        suggestedConditions: ["Condition.id"],
        suggestedHerbs: ["Herb.id"],
        safetyFlags: ["open_wound", "child", "pregnancy", "allergy"],
      },
    };

    return (
      <Card className="border-2">
        <CardHeader>
          <CardTitle>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏™‡∏Ñ‡∏µ‡∏°‡∏≤ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</CardTitle>
        </CardHeader>
        <CardContent>
          <pre className="text-xs bg-muted p-4 rounded overflow-auto">{JSON.stringify(schema, null, 2)}</pre>
        </CardContent>
      </Card>
    );
  };

  const SafetyNotice = () => (
    <div className="mt-4 p-4 rounded-2xl border bg-amber-50 text-amber-800 text-sm flex gap-3">
      <AlertTriangle className="mt-0.5" />
      <div>
        <div className="font-semibold">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
        <ul className="list-disc pl-5 mt-1 space-y-1">
          <li>‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏¥‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô <b>‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</b> ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå</li>
          <li>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</li>
          <li>‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å, ‡∏´‡∏ç‡∏¥‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå/‡πÉ‡∏´‡πâ‡∏ô‡∏°‡∏ö‡∏∏‡∏ï‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡∏•‡∏•‡∏∂‡∏Å/‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</li>
          <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏á‡∏ß‡∏ô</li>
        </ul>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-b from-white to-slate-50">
      <header className="sticky top-0 z-20 border-b bg-white/80 backdrop-blur">
        <div className="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Leaf />
            <div>
              <div className="font-bold text-lg">ThaiHerbSkin.AI</div>
              <div className="text-xs text-muted-foreground">‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</div>
            </div>
          </div>
          <div className="hidden md:flex items-center gap-2 text-xs text-muted-foreground">
            <Activity size={16} /> Prototype build
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-6 space-y-6">
        <Card className="border-2">
          <CardContent className="pt-6">
            <div className="grid md:grid-cols-3 gap-4">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-slate-100"><Camera /></div>
                <div>
                  <div className="font-semibold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û</div>
                  <div className="text-xs text-muted-foreground">‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ô‡∏±‡πâ‡∏ô <i>‡∏≠‡∏≤‡∏à</i>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡πÉ‡∏î</div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-slate-100"><HeartPulse /></div>
                <div>
                  <div className="font-semibold">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û</div>
                  <div className="text-xs text-muted-foreground">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (‡∏™‡∏≤‡∏ò‡∏¥‡∏ï)</div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-xl bg-slate-100"><Brain /></div>
                <div>
                  <div className="font-semibold">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
                  <div className="text-xs text-muted-foreground">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        <Tabs value={tab} onValueChange={setTab}>
          <TabsList className="grid grid-cols-3 w-full md:w-auto">
            <TabsTrigger value="herb">‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£</TabsTrigger>
            <TabsTrigger value="lesion">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ</TabsTrigger>
            <TabsTrigger value="symptom">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</TabsTrigger>
          </TabsList>

          {/* ---- Tab: Herb Identify ---- */}
          <TabsContent value="herb" className="mt-4">
            <div className="grid md:grid-cols-2 gap-6">
              <Card className="border-2">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><Camera /> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Input type="file" accept="image/*" onChange={(e) => onUpload(e, "herb")} />
                  {herbPreview && (
                    <img src={herbPreview} alt="herb" className="w-full rounded-xl border object-cover max-h-64" />
                  )}
                  <Button onClick={runHerbIdentify} disabled={!herbFile || herbLoading}>
                    {herbLoading ? (<span className="flex items-center gap-2"><Loader2 className="animate-spin" /> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‚Ä¶</span>) : "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏™‡∏≤‡∏ò‡∏¥‡∏ï)"}
                  </Button>
                </CardContent>
              </Card>

              <div className="space-y-4">
                {herbResult ? (
                  <ResultBlock
                    title={`‡∏ú‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: ${herbResult.herbName || "‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£"}`}
                    subtitle="‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢"
                    herbs={[herbResult.herbId]}
                    confidence={herbResult.confidence}
                    tips={["‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"]}
                  />
                ) : (
                  <Card className="h-full border-2">
                    <CardContent className="h-full flex items-center justify-center text-muted-foreground">
                      <div className="text-sm">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                    </CardContent>
                  </Card>
                )}
                <SafetyNotice />
              </div>
            </div>
          </TabsContent>

          {/* ---- Tab: Lesion Detect ---- */}
          <TabsContent value="lesion" className="mt-4">
            <div className="grid md:grid-cols-2 gap-6">
              <Card className="border-2">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><ImageIcon /> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏≠‡∏¢‡πÇ‡∏£‡∏Ñ‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Input type="file" accept="image/*" onChange={(e) => onUpload(e, "lesion")} />
                  {lesionPreview && (
                    <img src={lesionPreview} alt="lesion" className="w-full rounded-xl border object-cover max-h-64" />
                  )}
                  <Button onClick={runLesionDetect} disabled={!lesionFile || lesionLoading}>
                    {lesionLoading ? (<span className="flex items-center gap-2"><Loader2 className="animate-spin" /> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‚Ä¶</span>) : "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏™‡∏≤‡∏ò‡∏¥‡∏ï)"}
                  </Button>
                </CardContent>
              </Card>

              <div className="space-y-4">
                {lesionResult ? (
                  <ResultBlock
                    title={`‡∏™‡∏á‡∏™‡∏±‡∏¢: ${lesionResult.cond.nameTH}`}
                    subtitle="‡∏Ñ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠"
                    herbs={lesionResult.cond.herbs}
                    tips={lesionResult.cond.care}
                    confidence={lesionResult.confidence}
                  />
                ) : (
                  <Card className="h-full border-2">
                    <CardContent className="h-full flex items-center justify-center text-muted-foreground">
                      <div className="text-sm">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                    </CardContent>
                  </Card>
                )}
                <SafetyNotice />
              </div>
            </div>
          </TabsContent>

          {/* ---- Tab: Symptom NLP ---- */}
          <TabsContent value="symptom" className="mt-4">
            <div className="grid md:grid-cols-2 gap-6">
              <Card className="border-2">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2"><Search /> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Textarea rows={6} placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏±‡∏ô ‡πÅ‡∏î‡∏á ‡∏•‡∏≠‡∏Å ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏á ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ú‡∏∑‡πà‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á" value={symptomText} onChange={(e) => setSymptomText(e.target.value)} />
                  <div className="flex items-center gap-2">
                    <Button onClick={runSymptomNLP} disabled={symptomLoading || !symptomText.trim()}>
                      {symptomLoading ? (<span className="flex items-center gap-2"><Loader2 className="animate-spin" /> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‚Ä¶</span>) : "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (‡∏™‡∏≤‡∏ò‡∏¥‡∏ï)"}
                    </Button>
                    <Button variant="secondary" onClick={() => setSymptomText("")}>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</Button>
                  </div>
                </CardContent>
              </Card>

              <div className="space-y-4">
                {symptomResult ? (
                  <ResultBlock
                    title={`‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô: ${symptomResult.cond.nameTH}`}
                    subtitle="‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î (‡∏™‡∏≤‡∏ò‡∏¥‡∏ï)"
                    herbs={symptomResult.cond.herbs}
                    tips={symptomResult.cond.care}
                    confidence={symptomResult.confidence}
                  />
                ) : (
                  <Card className="h-full border-2">
                    <CardContent className="h-full flex items-center justify-center text-muted-foreground">
                      <div className="text-sm">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
                    </CardContent>
                  </Card>
                )}
                <SchemaTab />
                <SafetyNotice />
              </div>
            </div>
          </TabsContent>
        </Tabs>

        {/* Herb detail popup */}
        <HerbDialog />

        {/* Quick herb info chips (click to open) */}
        <div className="pt-2">
          <div className="text-xs text-muted-foreground mb-2">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ (‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö)</div>
          <div className="flex flex-wrap gap-2">
            {HERBS.map((h) => (
              <button
                key={h.id}
                onClick={() => { setActiveHerb(h.id); setOpenHerbDialog(true); }}
                className="text-sm px-3 py-1.5 rounded-full border hover:bg-slate-50"
              >
                {h.nameTH}
              </button>
            ))}
          </div>
        </div>
      </main>

      <footer className="max-w-6xl mx-auto px-6 py-8 text-xs text-muted-foreground">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
          <div>¬© {new Date().getFullYear()} ThaiHerbSkin.AI ‚Äî Prototype</div>
          <div className="flex items-center gap-2"><Info size={14} /> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå</div>
        </div>
      </footer>
    </div>
  );
}
